CREATE OR REPLACE FUNCTION update_tessera() RETURNS trigger AS $$
DECLARE 
	dt date;
BEGIN 
	UPDATE passeggero
	SET numvoli = (SELECT count(*) FROM volo JOIN biglietto ON biglietto.codicevolo = volo.codicevolo 
							   JOIN tratta ON (volo.partenza = tratta.partenza AND volo.arrivo = tratta.arrivo )
				WHERE passeggero.tessera=true AND passeggero.documento = biglietto.documento
				GROUP BY passeggero.documento ),
	miglia = (SELECT sum(distanza) FROM volo JOIN biglietto ON biglietto.codicevolo = volo.codicevolo 
							   JOIN tratta ON (volo.partenza = tratta.partenza AND volo.arrivo = tratta.arrivo )
				WHERE passeggero.tessera=true AND passeggero.documento = biglietto.documento
				GROUP BY passeggero.documento )
	FROM biglietto
	WHERE biglietto.dataemissione >= (SELECT date('now') - interval '3 year') AND NEW.documento = passeggero.documento;
	RETURN NEW;

END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tessera
AFTER INSERT OR DELETE ON biglietto
    FOR EACH ROW EXECUTE PROCEDURE update_tessera();